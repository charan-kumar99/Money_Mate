{% extends "base.html" %}

{% block title %}Dashboard - Expense Tracker Pro{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Track and manage your expenses efficiently{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="main-heading">
        <i class="fas fa-chart-line"></i>
        Expense Dashboard
    </h1>
    <p class="sub-heading">Monitor your spending and financial health</p>
</div>

<!-- Stats Grid -->
<div class="stat-grid">
    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-content">
            <h3>{{ currency }}{{ "%.2f"|format(total) }}</h3>
            <p>Total Expenses (Filtered)</p>
        </div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-icon">
            <i class="fas fa-list"></i>
        </div>
        <div class="stat-content">
            <h3>{{ expense_count }}</h3>
            <p>Number of Expenses</p>
        </div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-icon">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-content">
            <h3>{{ currency }}{{ "%.2f"|format(month_income) }}</h3>
            <p>This Month Income</p>
        </div>
    </div>

    <div class="stat-card {% if net_savings >= 0 %}success{% else %}danger{% endif %}">
        <div class="stat-icon">
            <i class="fas fa-piggy-bank"></i>
        </div>
        <div class="stat-content">
            <h3>{{ currency }}{{ "%.2f"|format(net_savings) }}</h3>
            <p>Net Savings (This Month)</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Add Expense Form -->
    <div class="col-lg-4">
        <div class="card fade-in">
            <div class="card-header">
                <i class="fas fa-plus-circle"></i>
                Add New Expense
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('index') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="category" name="category" list="categoryList" placeholder="Enter or select category" required>
                        <datalist id="categoryList">
                            <option value="Food & Dining">
                            <option value="Transportation">
                            <option value="Shopping">
                            <option value="Entertainment">
                            <option value="Bills & Utilities">
                            <option value="Healthcare">
                            <option value="Education">
                            <option value="Travel">
                            <option value="Personal Care">
                            <option value="Other">
                            {% for category in categories %}
                                <option value="{{ category }}">
                            {% endfor %}
                        </datalist>
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">{{ currency }}</span>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="cash">Cash</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="debit_card">Debit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="digital_wallet">Digital Wallet</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="note" class="form-label">Note (Optional)</label>
                        <textarea class="form-control" id="note" name="note" rows="2" placeholder="Add a note..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus me-2"></i>Add Expense
                    </button>
                </form>
                
                <hr class="my-4">
                
                <!-- CSV Upload -->
                <form method="POST" action="{{ url_for('upload_csv') }}" enctype="multipart/form-data" class="mb-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="file" class="form-label">Upload CSV</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv">
                        <div class="form-text">CSV format: Date, Category, Amount, Note, Payment Method</div>
                    </div>
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="fas fa-upload me-2"></i>Upload CSV
                    </button>
                </form>
                
                <!-- Export Button -->
                <a href="{{ url_for('export_csv', category_filter=category_filter, date_filter=date_filter, start_date=start_date, end_date=end_date, search_query=search_query, payment_filter=payment_filter) }}" 
                   class="btn btn-outline-success w-100 mb-3">
                    <i class="fas fa-download me-2"></i>Export CSV
                </a>
                
                <!-- Clear All Button -->
                <form method="POST" action="{{ url_for('clear_all') }}" onsubmit="return confirm('Are you sure you want to delete ALL expenses? This action cannot be undone.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-outline-danger w-100">
                        <i class="fas fa-trash me-2"></i>Clear All Expenses
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Filters and Expenses List -->
    <div class="col-lg-8">
        <!-- Filters -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <i class="fas fa-filter"></i>
                Filters & Search
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('index') }}">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category_filter">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category }}" {% if category_filter == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" name="payment_filter">
                                <option value="">All Methods</option>
                                <option value="cash" {% if payment_filter == 'cash' %}selected{% endif %}>Cash</option>
                                <option value="credit_card" {% if payment_filter == 'credit_card' %}selected{% endif %}>Credit Card</option>
                                <option value="debit_card" {% if payment_filter == 'debit_card' %}selected{% endif %}>Debit Card</option>
                                <option value="bank_transfer" {% if payment_filter == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
                                <option value="digital_wallet" {% if payment_filter == 'digital_wallet' %}selected{% endif %}>Digital Wallet</option>
                                <option value="other" {% if payment_filter == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" name="date_filter" id="date_filter">
                                <option value="">All Time</option>
                                <option value="last_7_days" {% if date_filter == 'last_7_days' %}selected{% endif %}>Last 7 Days</option>
                                <option value="last_30_days" {% if date_filter == 'last_30_days' %}selected{% endif %}>Last 30 Days</option>
                                <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>This Month</option>
                                <option value="last_month" {% if date_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                                <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}>Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Sort By</label>
                            <select class="form-select" name="sort_by">
                                <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Date (Newest)</option>
                                <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Date (Oldest)</option>
                                <option value="amount_desc" {% if sort_by == 'amount_desc' %}selected{% endif %}>Amount (High to Low)</option>
                                <option value="amount_asc" {% if sort_by == 'amount_asc' %}selected{% endif %}>Amount (Low to High)</option>
                                <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Category</option>
                            </select>
                        </div>
                        
                        <!-- Custom Date Range -->
                        <div class="col-md-6" id="custom_date_range" style="display: {% if date_filter == 'custom' %}block{% else %}none{% endif %};">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Search Notes</label>
                            <input type="text" class="form-control" name="search_query" value="{{ search_query }}" placeholder="Search in notes...">
                        </div>
                        
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Apply Filters
                                </button>
                                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>Clear
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Expenses List -->
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-receipt me-2"></i>
                    Expenses List
                    <span class="badge bg-primary ms-2">{{ expenses|length }} items</span>
                </div>
                <div class="text-success fw-bold">
                    Total: {{ currency }}{{ "%.2f"|format(total) }}
                </div>
            </div>
            <div class="card-body p-0">
                {% if expenses %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Payment</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <span class="badge bg-info">{{ expense.category }}</span>
                                </td>
                                <td class="fw-bold">{{ currency }}{{ "%.2f"|format(expense.amount) }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ expense.payment_method|replace('_', ' ')|title }}</span>
                                </td>
                                <td>
                                    {% if expense.note %}
                                        <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ expense.note }}">
                                            {{ expense.note }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" class="btn btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_expense', expense_id=expense.id) }}" 
                                              onsubmit="return confirm('Are you sure you want to delete this expense?');" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No expenses found</h5>
                    <p class="text-muted">Try adjusting your filters or add some expenses to get started.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Analytics Section -->
<div class="row mt-4">
    <!-- Top Categories -->
    <div class="col-md-6">
        <div class="card fade-in">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>
                Top Categories
            </div>
            <div class="card-body">
                {% if top_categories %}
                <div class="list-group list-group-flush">
                    {% for category, amount in top_categories %}
                    <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                        <div class="flex-grow-1">
                            <span class="fw-bold">{{ category }}</span>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar" style="width: {{ (amount / total * 100) if total > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        <span class="fw-bold text-primary ms-3">{{ currency }}{{ "%.2f"|format(amount) }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3 text-muted">
                    <i class="fas fa-chart-pie fa-2x mb-2"></i>
                    <p>No data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Monthly Trend -->
    <div class="col-md-6">
        <div class="card fade-in">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>
                Monthly Spending Trend
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Show/hide custom date range
    document.getElementById('date_filter').addEventListener('change', function() {
        const customRange = document.getElementById('custom_date_range');
        customRange.style.display = this.value === 'custom' ? 'block' : 'none';
    });

    // Monthly Trend Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels | tojson }},
            datasets: [{
                label: 'Monthly Spending',
                data: {{ monthly_totals | tojson }},
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#6366f1',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return '{{ currency }}' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) {
                            return '{{ currency }}' + value.toFixed(0);
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                }
            }
        }
    });
</script>
{% endblock %}