<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üí∏ Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
<div class="container py-4">

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="container mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Header -->
    <div class="header mb-4">
        <h1 class="main-heading">üí∏ Money Mate</h1>
        <p class="sub-heading">Track your spending and stay in control</p>
    </div>

    <!-- Total Expenses & Actions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="summary-box">
                <h4 class="section-heading">Total Expenses</h4>
                <p>‚Çπ {{ "%.2f"|format(total) }}</p>
            </div>
        </div>
        <div class="col-md-6 text-end d-flex align-items-end justify-content-end">
            <div>
                <a href="/export?category_filter={{ category_filter }}&date_filter={{ date_filter }}&start_date={{ start_date }}&end_date={{ end_date }}" 
                   class="btn btn-success me-2"> Export CSV</a>
                <button type="button" class="btn btn-danger" onclick="showClearModal()"> Clear All</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Form -->
    <div class="card mb-4">
        <div class="card-header section-heading"> Add New Expense</div>
        <div class="card-body">
            <form method="POST" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    <input type="date" name="date" class="form-control" required value="{{ datetime.now().strftime('%Y-%m-%d') }}" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <input type="text" name="category" class="form-control" placeholder="e.g. Groceries, Food, Transport" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" step="0.01" name="amount" class="form-control" placeholder="e.g. 500.00" required min="0.01" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Note (Optional)</label>
                    <input type="text" name="note" class="form-control" placeholder="Additional details" />
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary"> Add Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload CSV -->
    <div class="card mb-4">
        <div class="card-header section-heading"> Upload Expenses from CSV</div>
        <div class="card-body">
            <form action="/upload" method="POST" enctype="multipart/form-data" class="row g-3">
                <div class="col-md-8">
                    <input type="file" name="file" class="form-control" accept=".csv" required />
                    <div class="form-text text-muted mt-2">
                        <small> <strong>CSV Format:</strong> Date (YYYY-MM-DD), Category, Amount, Note (optional)</small>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button type="submit" class="btn btn-info"> Upload CSV</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="card mb-4">
        <div class="card-header section-heading"> Advanced Filters</div>
        <div class="card-body">
            <form method="GET" class="row g-3" id="filterForm">
                <div class="col-md-3">
                    <label class="form-label">Filter by Category</label>
                    <select name="category_filter" class="form-select">
                        <option value="">-- All Categories --</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select name="date_filter" class="form-select" id="dateRangeSelect">
                        <option value="">-- All Time --</option>
                        <option value="last_7_days" {% if date_filter == 'last_7_days' %}selected{% endif %}> Last 7 Days</option>
                        <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}> This Month</option>
                        <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}> Custom Range</option>
                    </select>
                </div>
                <div class="col-md-3" id="customDateStart" style="display: {% if date_filter == 'custom' %}block{% else %}none{% endif %};">
                    <label class="form-label">Start Date</label>
                    <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-3" id="customDateEnd" style="display: {% if date_filter == 'custom' %}block{% else %}none{% endif %};">
                    <label class="form-label">End Date</label>
                    <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>

                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary"> Apply Filters</button>
                    <a href="/" class="btn btn-secondary ms-2"> Clear Filters</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Current Filter Display -->
    {% if category_filter or date_filter %}
    <div class="alert alert-info">
        <strong> Active Filters:</strong>
        {% if category_filter %}<span class="badge bg-primary me-2">Category: {{ category_filter }}</span>{% endif %}
        {% if date_filter == 'last_7_days' %}<span class="badge bg-success me-2">Last 7 Days</span>{% endif %}
        {% if date_filter == 'this_month' %}<span class="badge bg-warning me-2">This Month</span>{% endif %}
        {% if date_filter == 'custom' %}<span class="badge bg-info me-2">{{ start_date }} to {{ end_date }}</span>{% endif %}
        <span class="ms-3"> Showing <strong>{{ expenses|length }}</strong> expense(s) | Total: <strong>‚Çπ{{ "%.2f"|format(total) }}</strong></span>
    </div>
    {% endif %}

    <!-- Expense History Table -->
    <div class="card mb-4">
        <div class="card-header section-heading d-flex justify-content-between align-items-center">
            <span> Expense History</span>
            <span class="badge bg-secondary">{{ expenses|length }} expenses</span>
        </div>
        <div class="card-body p-0">
            {% if expenses %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Note</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.date.strftime('%d-%m-%Y') }}</td>
                            <td><span class="category-badge">{{ expense.category }}</span></td>
                            <td class="amount-cell">‚Çπ{{ "%.2f"|format(expense.amount) }}</td>
                            <td>{{ expense.note if expense.note else '-' }}</td>
                            <td>
                                <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" 
                                   class="btn btn-sm btn-warning me-1" title="Edit">Edit</a>
                                <button type="button" class="btn btn-sm btn-danger" title="Delete"
                                        onclick="showDeleteModal('{{ expense.id }}', '{{ expense.category }}', '{{ expense.amount }}', '{{ expense.date.strftime('%d-%m-%Y') }}', '{{ expense.note if expense.note else '' }}')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <h5 class="text-muted">No expenses found</h5>
                <p class="text-muted">
                    {% if category_filter or date_filter %}
                        Try adjusting your filters or <a href="/" class="text-decoration-none">clear all filters</a>
                    {% else %}
                        Add some expenses to get started with tracking your spending!
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">‚ö†Ô∏è Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="expense-details p-3 rounded" style="background: rgba(220,53,69,0.1); border:1px solid rgba(220,53,69,0.3);">
                    <div class="row">
                        <div class="col-6"><small class="text-muted">Category:</small><div class="fw-bold" id="deleteCategory"></div></div>
                        <div class="col-6"><small class="text-muted">Amount:</small><div class="fw-bold text-danger" id="deleteAmount"></div></div>
                        <div class="col-6 mt-2"><small class="text-muted">Date:</small><div id="deleteDate"></div></div>
                        <div class="col-6 mt-2"><small class="text-muted">Note:</small><div id="deleteNote"></div></div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-warning">‚ö†Ô∏è This action cannot be undone!</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger"> Yes, Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Clear All Confirmation Modal -->
<div class="modal fade" id="clearModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Clear All Expenses</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h6 class="text-white">Are you sure you want to delete ALL expenses?</h6>
                <p class="text-muted">This will permanently remove all {{ expenses|length if expenses else 0 }} expenses.</p>
                <small class="text-danger"><strong>‚ö†Ô∏è WARNING: This action cannot be undone!</strong></small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancel</button>
                <form action="/clear" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger"> Yes, Clear All</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function showDeleteModal(expenseId, category, amount, date, note) {
        document.getElementById('deleteCategory').textContent = category;
        document.getElementById('deleteAmount').textContent = '‚Çπ' + amount;
        document.getElementById('deleteDate').textContent = date;
        document.getElementById('deleteNote').textContent = note || '-';
        document.getElementById('deleteForm').action = `/delete/${expenseId}`;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function showClearModal() {
        const clearModal = new bootstrap.Modal(document.getElementById('clearModal'));
        clearModal.show();
    }

    document.getElementById('dateRangeSelect').addEventListener('change', function() {
        const customStart = document.getElementById('customDateStart');
        const customEnd = document.getElementById('customDateEnd');
        if (this.value === 'custom') {
            customStart.style.display = 'block';
            customEnd.style.display = 'block';
        } else {
            customStart.style.display = 'none';
            customEnd.style.display = 'none';
            document.getElementById('filterForm').submit();
        }
    });

    document.querySelector('select[name="category_filter"]').addEventListener('change', function() {
        if (document.querySelector('select[name="date_filter"]').value !== 'custom') {
            document.getElementById('filterForm').submit();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.querySelector('input[name="date"]');
        if (!dateInput.value) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    });
</script>
</body>
</html>